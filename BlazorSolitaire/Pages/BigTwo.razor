@page "/bigtwo"
@using BlazorSolitaire.Models.BigTwo
@using BlazorSolitaire.Models.Core
@using BlazorSolitaire.Pages.BigTwoComponents

<div class="game-container">
    @if (Game != null)
    {
        <div class="game-table">
            <!-- Top-Right Game Status -->
            <div class="status-overlay">
                @Game.GameStatusMessage
            </div>

            <TableCenter PlayedCards="Game.LastPlayedCards" />

            <!-- CPU Players -->
            <PlayerHand Cards="Game.Player2Hand" Placement="Top" PlayerName="CPU 2" />
            <PlayerHand Cards="Game.Player4Hand" Placement="Left" PlayerName="CPU 4" />
            <PlayerHand Cards="Game.Player3Hand" Placement="Right" PlayerName="CPU 3" />
            
            <!-- User Player -->
            <PlayerHand Cards="Game.Player1Hand" 
                        Placement="Bottom" 
                        IsUser="true" 
                        PlayerName="YOU"
                        OnNewGame="NewGame"
                        OnPlay="PlayCard" 
                        OnPass="PassTurn" />
        </div>
    }
    else
    {
         <div class="start-screen">
             <h1 class="title-main">Big Two 大老二</h1>
             <button class="btn btn-primary btn-lg start-btn" @onclick="NewGame">Start Game</button>
        </div>
    }
</div>

<style>
    /* Global Container Styles */
    .game-container {
        width: 100vw;
        height: 100vh;
        overflow: hidden;
        background-color: #222;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .game-table {
        position: relative;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle at center, #2ecc71 0%, #27ae60 40%, #145a32 100%);
        box-shadow: inset 0 0 100px rgba(0,0,0,0.5);
    }
    
    .start-screen {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100%;
        color: white;
        background: radial-gradient(circle, #2c3e50, #000);
    }
    .title-main {
        font-size: 5rem;
        margin-bottom: 2rem;
        text-shadow: 0 0 20px #f1c40f;
        font-family: 'KaiTi', 'SimKai', serif;
    }
    .start-btn {
        padding: 15px 40px;
        font-size: 1.5rem;
        border-radius: 50px;
        transition: transform 0.2s;
        box-shadow: 0 0 15px rgba(52, 152, 219, 0.7);
    }
    .start-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 0 25px rgba(52, 152, 219, 1);
    }

    .status-overlay {
        position: absolute;
        top: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.7);
        padding: 15px 25px;
        border-radius: 10px;
        color: white;
        font-size: 1.5rem;
        font-weight: bold;
        z-index: 100;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        border: 1px solid rgba(255,255,255,0.2);
        backdrop-filter: blur(5px);
    }
</style>

@code {
    BigTwoGame Game;

    void NewGame()
    {
        Game = new BigTwoGame();
        Game.Deal();
        CheckTurn();
    }

    async void PlayCard(List<ICard> cards)
    {
        if (Game.CurrentPlayerIndex != 0) return; // Not user's turn

        if (Game.Play(cards))
        {
            await CheckTurn();
        }
    }

    async void PassTurn()
    {
         if (Game.CurrentPlayerIndex != 0) return;

         Game.Pass();
         await CheckTurn();
    }

    async Task CheckTurn()
    {
        if (Game == null || Game.IsGameOver) return;

        StateHasChanged();

        while (Game.CurrentPlayerIndex != 0 && !Game.IsGameOver)
        {
            await Task.Delay(1000); // Thinking time
            Game.AutoPlay();
            StateHasChanged();
        }
    }
}
