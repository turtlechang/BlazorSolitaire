@using BlazorSolitaire.Models.Core
@using BlazorSolitaire.Models.BigTwo

<div class="player-area player-@Placement.ToLower() @(IsUser ? "user-area" : "")">
    
    <div class="player-info">
        <div class="avatar @(IsUser ? "user-avatar" : "")">@PlayerName</div>
        <div class="stats">Cards: @(Cards?.Count() ?? 0)</div>
    </div>

    <!-- Hand Container -->
    <div class="@HandClass">
        @if (Cards != null)
        {
            @foreach (var card in Cards)
            {
                <div class="@GetCardWrapperClass(card)" @onclick="() => OnCardClick(card)">
                    @if (IsUser && card is BigTwoCard bigTwoCard)
                    {
                        <img src="images/common/@(bigTwoCard.ImageName).png" class="card-face" title="@bigTwoCard.Suit @bigTwoCard.Value" />
                    }
                    else
                    {
                         <img src="images/common/cardBack.png" class="@CardBackClass" />
                    }
                </div>
            }
        }
    </div>

    @if (IsUser)
    {
         <div class="control-panel">
             <button class="btn btn-warning btn-sm" @onclick="HandleNewGame">新局</button>
              <button class="btn btn-primary btn-sm" @onclick="HandlePlay">出牌</button>
              <button class="btn btn-secondary btn-sm" @onclick="HandlePass">Pass</button>
        </div>
    }
</div>

<style>
    /* Player Areas Positioning (Scoped/Local) */
    .player-area {
        position: absolute;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
        transition: all 0.5s ease;
    }

    /* Info */
    .player-info {
        display: flex;
        flex-direction: column;
        align-items: center;
        color: white;
        text-shadow: 1px 1px 2px black;
        margin: 10px;
        z-index: 20;
    }
    .avatar {
        width: 60px;
        height: 60px;
        background-color: #34495e;
        border: 3px solid #f1c40f;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        font-weight: bold;
        margin-bottom: 5px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        font-size: 0.9rem;
    }
    .user-avatar {
        width: 80px;
        height: 80px;
        border-color: #e74c3c;
        font-size: 1.2rem;
    }
    .stats {
        font-size: 0.8rem;
        background: rgba(0,0,0,0.6);
        padding: 2px 10px;
        border-radius: 12px;
        backdrop-filter: blur(2px);
    }

    /* Control Panel */
    .control-panel {
        margin-bottom: 20px;
        display: flex;
        gap: 10px;
        z-index: 30;
    }

    /* Placements */
    .player-top {
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        flex-direction: column;
    }
    .player-bottom {
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        flex-direction: column-reverse; /* Avatar at bottom, controls at top of area */
    }
    .player-left {
        left: 20px;
        top: 50%;
        transform: translateY(-50%);
        flex-direction: row;
    }
    .player-right {
        right: 20px;
        top: 50%;
        transform: translateY(-50%);
        flex-direction: row-reverse;
    }

    /* Hand Styles */
    .hand-horizontal {
        display: flex;
        justify-content: center;
    }
    .hand-vertical {
        display: flex;
        flex-direction: column;
        justify-content: center;
        height: 300px; /* Limit height */
    }

    /* Card Wrappers */
    .card-wrapper-h { /* Opponent Horizontal */
        margin-right: -45px;
        transition: margin 0.3s;
    }
    .card-wrapper-h:last-child { margin-right: 0; }
    
    .card-wrapper-v { /* Opponent Vertical */
        margin-bottom: -75px;
        transition: margin 0.3s;
    }
    .card-wrapper-v:last-child { margin-bottom: 0; }

    .card-wrapper-user { /* User */
        margin-right: -55px;
        transition: transform 0.2s, margin 0.2s;
        cursor: pointer;
        position: relative;
    }
    .card-wrapper-user:last-child { margin-right: 0; }
    
    .card-wrapper-user:hover {
        transform: translateY(-20px);
        margin-right: -30px;
        z-index: 100;
    }
    .card-wrapper-user.selected {
        transform: translateY(-30px);
        z-index: 100;
        filter: brightness(1.1);
    }

    /* Card Images */
    .card-back {
        width: 60px;
        border-radius: 4px;
        box-shadow: -1px 1px 4px rgba(0,0,0,0.3);
    }
    .card-back-v {
        width: 60px;
        border-radius: 4px;
        box-shadow: 0 1px 4px rgba(0,0,0,0.3);
    }
    .card-face {
        width: 100px; /* User cards slightly larger */
        border-radius: 6px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.4);
    }

    @@media (max-width: 800px) {
        .player-left, .player-right {
           /*  display: none; Maybe scale down instead of hide? Use scale */
           transform: translateY(-50%) scale(0.6);
           pointer-events: none;
        }
        .card-face { width: 70px; }
        .player-bottom { bottom: 5px; }
    }
</style>

@code {
    [Parameter] public IEnumerable<ICard> Cards { get; set; }
    [Parameter] public string Placement { get; set; } = "Bottom"; // Top, Bottom, Left, Right
    [Parameter] public bool IsUser { get; set; } = false;
    [Parameter] public string PlayerName { get; set; } = "Player";
    
    [Parameter] public EventCallback OnNewGame { get; set; }
    [Parameter] public EventCallback<List<ICard>> OnPlay { get; set; }
    [Parameter] public EventCallback OnPass { get; set; }

    // Internal selection state
    private HashSet<ICard> _selectedCards = new HashSet<ICard>();

    private void OnCardClick(ICard card)
    {
        if (!IsUser) return;
        
        if (_selectedCards.Contains(card))
        {
            _selectedCards.Remove(card);
        }
        else
        {
            _selectedCards.Add(card);
        }
        StateHasChanged();
    }

    private async Task HandleNewGame()
    {
       _selectedCards.Clear();
       if (OnNewGame.HasDelegate) await OnNewGame.InvokeAsync();
    }

    private async Task HandlePlay()
    {
        if (OnPlay.HasDelegate) 
        {
            await OnPlay.InvokeAsync(_selectedCards.ToList());
        }
        _selectedCards.Clear(); 
    }

    private async Task HandlePass()
    {
        _selectedCards.Clear();
         if (OnPass.HasDelegate) await OnPass.InvokeAsync();
    }

    // Helpers for classes
    private bool IsVertical => Placement == "Left" || Placement == "Right";

    private string HandClass => IsVertical ? "hand-vertical" : "hand-horizontal" + (IsUser ? " user-hand" : "");

    private string GetCardWrapperClass(ICard card)
    {
        if (IsUser)
        {
            return "card-wrapper-user" + (_selectedCards.Contains(card) ? " selected" : "");
        }
        return IsVertical ? "card-wrapper-v" : "card-wrapper-h";
    }

    private string CardBackClass => IsVertical ? "card-back-v" : "card-back";
}
